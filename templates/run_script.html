<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Run {{ script_name }} | Script Server</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
    crossorigin="anonymous"
  />

  <!-- Bootstrap Icons CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f4f6f9;
    }
    .card-hover:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      transition: 0.2s;
    }
    .header-small {
      background-color: #343a40;
      color: white;
      padding: 1rem;
      border-radius: 0.25rem;
      margin-bottom: 1.5rem;
    }
    #logOutput {
      background-color: #212529;
      color: #f8f9fa;
      padding: 1rem;
      border-radius: 0.25rem;
      height: 450px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: Consolas, "Courier New", monospace;
      font-size: 0.9rem;
    }
    footer {
      margin-top: 3rem;
      padding: 1rem 0;
      background-color: #e9ecef;
      text-align: center;
      font-size: 0.9rem;
      color: #6c757d;
    }
    .type-badge {
      font-size: 0.75rem;
      margin-left: 0.5rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <i class="bi bi-terminal-fill me-2"></i>
        Back to Scripts
      </a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navToggle"
        aria-controls="navToggle"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navToggle"></div>
    </div>
  </nav>

  <!-- Header / Breadcrumb -->
  <div class="container">
    <div class="header-small d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Running: <code>{{ script_name }}</code></h4>
      <span class="text-muted">Select a function and supply parameters below</span>
    </div>

    <div class="row gy-4">
      <!-- Left Column: Form -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm card-hover">
          <div class="card-body">
            <h5 class="card-title mb-3"><i class="bi bi-gear-fill"></i> Select &amp; Configure</h5>
            <form id="runForm">
              <!-- Hidden fields for named flags: --script and --function -->
              <input type="hidden" name="script" value="{{ script_name[:-3] }}" />
              <input type="hidden" id="hiddenFunction" name="function" value="" />

              <!-- Function Selector -->
              <div class="mb-4">
                <label for="function_name" class="form-label">Function</label>
                <select
                  name="function_name"
                  id="function_name"
                  class="form-select"
                  required
                >
                  <option value="" disabled selected>Choose a function…</option>
                  {% for fname, sig in functions_signatures.items() %}
                    <option value="{{ fname }}">{{ fname }}{{ sig }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Dynamic Parameter Panels -->
              {% for fname, params_list in functions_meta.items() %}
                <div
                  id="params_{{ fname }}"
                  class="params-block mb-3"
                  style="display: none;"
                >
                  <h6 class="text-secondary mb-3">
                    <i class="bi bi-sliders"></i> {{ fname }} Parameters
                  </h6>

                  {% for p in params_list %}
                    <div class="form-floating mb-3">
                      {% if p.input_type == "number" %}
                        <input
                          type="number"
                          step="{{ p.step }}"
                          class="form-control"
                          id="param_{{ p.name }}"
                          name="{{ p.name }}"
                          placeholder="{{ p.name }}"
                          data-type="{{ p.dtype }}"
                          value="{% if p.default is not none %}{{ p.default }}{% else %}{% endif %}"
                          {% if p.default is none %} required {% endif %}
                        />
                      {% else %}
                        <input
                          type="text"
                          class="form-control"
                          id="param_{{ p.name }}"
                          name="{{ p.name }}"
                          placeholder="{{ p.name }}"
                          data-type="{{ p.dtype }}"
                          value="{% if p.default is not none %}{{ p.default }}{% else %}{% endif %}"
                          {% if p.default is none %} required {% endif %}
                        />
                      {% endif %}
                      <label for="param_{{ p.name }}">
                        {{ p.name }}
                        <span class="type-badge">({{ p.type_name }})</span>
                        {% if p.default is not none %}
                          <small class="text-muted">default: {{ p.default }}</small>
                        {% endif %}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}

              <button type="submit" class="btn btn-success w-100">
                <i class="bi bi-play-fill"></i> Execute
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Right Column: Live Logs -->
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm card-hover">
          <div class="card-body">
            <h5 class="card-title mb-3"><i class="bi bi-terminal"></i> Live Logs</h5>
            <div id="logOutput">Awaiting command…</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      &copy; 2025 Script Server • Powered by Flask &amp; Bootstrap 5
    </footer>
  </div>

  <!-- Bootstrap 5 JS Bundle (with Popper) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"
  ></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const functionSelect = document.getElementById("function_name");
      const hiddenFunction = document.getElementById("hiddenFunction");
      const paramsBlocks = document.querySelectorAll(".params-block");
      const runForm = document.getElementById("runForm");
      const logBox = document.getElementById("logOutput");

      // Show/hide parameter panels based on selected function
      function toggleParams() {
        paramsBlocks.forEach((block) => {
          block.style.display = "none";
        });
        const active = document.getElementById(`params_${functionSelect.value}`);
        if (active) {
          active.style.display = "block";
        }
        hiddenFunction.value = functionSelect.value;
      }
      functionSelect.addEventListener("change", toggleParams);
      toggleParams();  // Initialize on page load

      // Validate a single field’s value against its data-type
      function validateField(input) {
        const dtype = input.getAttribute("data-type");
        const val = input.value.trim();
        if (dtype === "int") {
          return val !== "" && !isNaN(val) && Number.isInteger(Number(val));
        }
        if (dtype === "float") {
          return val !== "" && !isNaN(val);
        }
        // For any other annotation (including 'string'), accept non-empty
        return val !== "";
      }

      // On form submission, perform client-side type validation
      runForm.addEventListener("submit", function (e) {
        e.preventDefault();
        logBox.textContent = ""; // Clear previous logs

        const activePanel = document.getElementById(`params_${functionSelect.value}`);
        if (activePanel) {
          const inputs = activePanel.querySelectorAll("input[name]");
          for (const input of inputs) {
            if (!validateField(input)) {
              const dtype = input.getAttribute("data-type");
              alert(`Invalid value for “${input.name}”: expected ${dtype}.`);
              input.focus();
              return;
            }
          }
        }

        // Build FormData once validation passes
        const formData = new FormData();
        formData.append("script", "{{ script_name[:-3] }}");
        formData.append("function", functionSelect.value);

        if (activePanel) {
          activePanel.querySelectorAll("input[name]").forEach((input) => {
            formData.append(input.name, input.value);
          });
        }

        fetch("{{ url_for('run_script') }}", {
          method: "POST",
          body: formData
        })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
          }
          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");

          function readChunk() {
            reader.read().then(({ done, value }) => {
              if (done) {
                logBox.textContent += "\n\n[Process completed]\n";
                return;
              }
              const chunk = decoder.decode(value);
              logBox.textContent += chunk;
              logBox.scrollTop = logBox.scrollHeight;
              readChunk();
            });
          }
          readChunk();
        })
        .catch((err) => {
          logBox.textContent = "Error streaming logs:\n" + err.message;
        });
      });
    });
  </script>
</body>
</html>